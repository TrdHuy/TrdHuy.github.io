<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>GitHub File List</title>
     <style>
          table {
               width: 100%;
               border-collapse: collapse;
          }

          table,
          th,
          td {
               border: 1px solid black;
          }

          th,
          td {
               padding: 10px;
               text-align: left;
          }

          .modal {
               display: none;
               position: fixed;
               z-index: 1;
               left: 0;
               top: 0;
               width: 100%;
               height: 100%;
               overflow: auto;
               background-color: rgb(0, 0, 0);
               background-color: rgba(0, 0, 0, 0.4);
          }

          .modal-content {
               background-color: #fefefe;
               margin: 15% auto;
               padding: 20px;
               border: 1px solid #888;
               width: 80%;
          }

          .close {
               color: #aaa;
               float: right;
               font-size: 28px;
               font-weight: bold;
          }

          .close:hover,
          .close:focus {
               color: black;
               text-decoration: none;
               cursor: pointer;
          }
     </style>
</head>

<body>
     <button id="loadButton">Load Files</button>

     <div id="myModal" class="modal">
          <div class="modal-content">
               <span class="close">&times;</span>
               <label for="token">Token:</label>
               <input type="password" id="token" name="token">
               <button id="submitToken">OK</button>
          </div>
     </div>

     <table id="fileTable" style="display: none;">
          <thead>
               <tr>
                    <th>File Name</th>
                    <th>File Path</th>
                    <th>Project id</th>
                    <th>Report creation time</th>
               </tr>
          </thead>
          <tbody id="fileTableBody">
          </tbody>
     </table>

     <script>
          function ticksToDate(ticks) {
               // Ticks từ ngày 1/1/0001, cần trừ đi số ticks từ 1/1/1970 (Unix epoch)
               const ticksPerSecond = 10000000; // 10 triệu ticks mỗi giây
               const unixEpochTicks = 621355968000000000; // Ticks từ 1/1/0001 đến 1/1/1970

               // Chuyển đổi tick sang thời gian Unix timestamp (giây)
               const unixTime = (ticks - unixEpochTicks) / ticksPerSecond;

               // Chuyển đổi Unix timestamp sang đối tượng Date
               return new Date(unixTime * 1000).toLocaleString(); // Chuyển đổi giây sang mili giây
          }

          // Xóa dữ liệu sessionStorage khi trang được tải lại
          window.addEventListener('load', function () {
               localStorage.removeItem('githubDataTrees');
          });

          var modal = document.getElementById("myModal");
          var btn = document.getElementById("loadButton");
          var span = document.getElementsByClassName("close")[0];
          const folderPath = 'CoverageReport'; // Thay đổi bằng đường dẫn đến folder trong repo của bạn

          btn.onclick = function () {
               const cachedFiles = localStorage.getItem('githubDataTrees');

               if (cachedFiles) {
                    const files = JSON.parse(cachedFiles);
                    const filteredFiles = files.filter(item => item.path.startsWith(folderPath) && item.type === 'blob' && item.path.endsWith('.html'));
                    displayFiles(filteredFiles, files);
               } else {
                    modal.style.display = "block";
               }
          }

          span.onclick = function () {
               modal.style.display = "none";
          }

          window.onclick = function (event) {
               if (event.target == modal) {
                    modal.style.display = "none";
               }
          }
          document.getElementById('submitToken').addEventListener('click', async function () {
               const token = document.getElementById('token').value;
               await loadFiles(token);
          });

          async function loadFiles(token) {
               const user = 'TrdHuy'; // Thay đổi bằng tên repo của bạn
               const repo = 'TrdHuy.github.io'; // Thay đổi bằng tên repo của bạn
               const branch = 'master'; // Thay đổi bằng đường dẫn đến folder trong repo của bạn
               const url = `https://api.github.com/repos/${user}/${repo}/git/trees/${branch}?recursive=1`;

               try {
                    const response = await fetch(url, {
                         headers: {
                              'Authorization': `token ${token}`
                         }
                    });

                    if (response.ok) {
                         const data = await response.json();
                         // Lọc các tệp trong hoặc dưới thư mục CoverageReport
                         const files = data.tree.filter(item => item.path.startsWith(folderPath) && item.type === 'blob' && item.path.endsWith('.html'));
                         localStorage.setItem('githubDataTrees', JSON.stringify(data.tree));
                         await displayFiles(files, data.tree);
                         document.getElementById('myModal').style.display = 'none';
                    } else {
                         alert('Failed to fetch files. Please check your token and repo path.');
                    }
               } catch (error) {
                    console.error('Error fetching files:', error);
                    alert('An error occurred. Please try again.');
               }
          }
          async function displayFiles(files, allFiles) {
               const fileTableBody = document.getElementById('fileTableBody');
               fileTableBody.innerHTML = '';

               for (const file of files) {
                    const pathParts = file.path.split('/');
                    const projectName = pathParts[pathParts.length - 3];
                    const timestamp = pathParts[pathParts.length - 2];
                    const creationDate = ticksToDate(parseInt(timestamp)); // Chuyển đổi từ tick sang thời gian

                    const propertiesJsonPath = pathParts.slice(0, -1).concat('properties.json').join('/');
                    let propertiesFile = allFiles.find(f => f.path === propertiesJsonPath);
                    let propertiesContent = 'N/A';

                    if (propertiesFile) {
                         cacheContent = propertiesFile.cacheContent
                         if (!cacheContent) {
                              try {
                                   const response = await fetch(propertiesFile.url);
                                   const json = await response.json();
                                   const contentBase64 = json.content;
                                   const content = atob(contentBase64);
                                   propertiesContent = JSON.stringify(JSON.parse(content), null, 2);
                                   propertiesFile.cacheContent = propertiesContent
                                   cacheContent = propertiesContent
                                   localStorage.setItem('githubDataTrees', JSON.stringify(allFiles));
                              } catch (error) {
                                   propertiesContent = 'Error loading properties';
                              }
                         }
                         propertiesContent = cacheContent
                    }
                    const row = document.createElement('tr');
                    const nameCell = document.createElement('td');
                    const pathCell = document.createElement('td');
                    const projectCell = document.createElement('td');
                    const dateCell = document.createElement('td');
                    const propertiesCell = document.createElement('td');

                    nameCell.textContent = file.path.split('/').pop(); // Lấy tên tệp
                    const pathLink = document.createElement('a');
                    pathLink.href = `https://trdhuy.github.io/${file.path}`;
                    pathLink.textContent = file.path;
                    pathLink.target = '_blank'; // Mở liên kết trong tab mới
                    pathCell.appendChild(pathLink);

                    projectCell.textContent = projectName;
                    dateCell.textContent = creationDate;
                    propertiesCell.textContent = propertiesContent;

                    row.appendChild(nameCell);
                    row.appendChild(pathCell);
                    row.appendChild(projectCell);
                    row.appendChild(dateCell);
                    row.appendChild(propertiesCell);

                    fileTableBody.appendChild(row);
               }

               document.getElementById('fileTable').style.display = 'table';
          }
     </script>
</body>

</html>